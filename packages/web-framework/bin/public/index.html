<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Main Page</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/htmx.org@2.x.x/dist/htmx.min.js"></script>
    <link rel="stylesheet" type="text/css" href="scripts/main.css"/>
</head>
<body x-data="{}">
<h1>Welcome</h1>
<div id="login-container"
     hx-get="fragments/login-component.html"
     hx-trigger="load"
     hx-select=".box"
     hx-swap="innerHTML">
    <!-- Login content will be injected here by HTMX -->
</div>

<script nonce="%%CSP_NONCE%%">
    document.addEventListener( 'DOMContentLoaded', function () {
        if ( window.htmx ) {
            htmx.config.inlineScriptNonce = '%%CSP_NONCE%%';
            htmx.config.inlineStyleNonce = '%%CSP_STYLE_NONCE%%';
        }
    } );

    // Initialize an Alpine store for auth-related state (e.g., CSRF token)
    document.addEventListener( 'alpine:init', () => {
        Alpine.store( 'auth', { csrfToken: '' } );
    } );

    // Bind the login form submission to fetch with CSRF from the Alpine store
    function bindForm() {
        const form = document.querySelector( '#loginForm' );
        if ( !form ) return; // local auth might be disabled
        const errorEl = document.querySelector( '#error' );
        form.addEventListener( 'submit', async ( ev ) => {
            ev.preventDefault();
            if ( errorEl ) errorEl.style.display = 'none';
            const username = ( document.querySelector( '#username' ) || {} ).value || '';
            const password = ( document.querySelector( '#password' ) || {} ).value || '';
            let csrf = '';
            try {
                csrf = ( Alpine.store( 'auth' ) && Alpine.store( 'auth' ).csrfToken ) || '';
            } catch ( _ ) {
            }
            try {
                const res = await fetch( '/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-csrf-token': csrf
                    },
                    body: JSON.stringify( { username, password } )
                } );
                const data = await res.json().catch( () => ( {} ) );
                if ( res.ok && data && ( data.ok || data.redirectTo ) ) {
                    window.location.href = data.redirectTo || '/dashboard';
                } else {
                    if ( errorEl ) {
                        errorEl.textContent = ( data && data.error ) ? String( data.error ) : 'Login failed';
                        errorEl.style.display = 'block';
                    }
                }
            } catch ( err ) {
                if ( errorEl ) {
                    errorEl.textContent = 'Network error';
                    errorEl.style.display = 'block';
                }
            }
        }, { once: true } );
    }

    // Capture CSRF token from the HTMX response header
    document.addEventListener( 'htmx:afterOnLoad', ( e ) => {
        try {
            const xhr = e && e.detail && e.detail.xhr;
            if ( !xhr ) return;
            const token = xhr.getResponseHeader( 'x-csrf-token' );
            if ( token ) {
                try {
                    Alpine.store( 'auth' ).csrfToken = token;
                } catch ( _ ) {
                }
            }
        } catch ( _ ) { /* no-op */
        }
    } );

    // Bind the form after HTMX swaps the fragment into the container
    document.addEventListener( 'htmx:afterSwap', ( e ) => {
        const tgt = e && e.target;
        if ( tgt && tgt.id === 'login-container' ) {
            bindForm();
        }
    } );
</script>
</body>
</html>